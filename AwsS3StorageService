using System;
using System.IO;
using System.Threading.Tasks;
using Amazon;
using Amazon.S3;
using Amazon.S3.Model;
using LmsPoc.Application.Interfaces;
using Microsoft.Extensions.Configuration;

namespace LmsPoc.Infrastructure.Storage
{
    /// <summary>
    /// AWS S3 üzerinde dosya saklama işlemlerini yapan servis.
    /// Uygulama bu sınıfı doğrudan değil, IStorageService arayüzü
    /// üzerinden kullanmalı.
    /// </summary>
    public class AwsS3StorageService : IStorageService
    {
        private readonly IAmazonS3 _s3Client;
        private readonly string _bucketName;

        public AwsS3StorageService(IConfiguration config)
        {
            try
            {
                // Örn: appsettings.json içinde "Aws:BucketName", "Aws:Region" vb.
                _bucketName = config["Aws:BucketName"]
                              ?? throw new ArgumentException("Aws:BucketName tanımlı değil.");

                var regionName = config["Aws:Region"] ?? "eu-central-1";
                var region = RegionEndpoint.GetBySystemName(regionName);

                // Burada credential'ları ister IAM role'den, ister config'ten
                // alabilirsin. POC için basit ctor kullanıyorum.
                _s3Client = new AmazonS3Client(region);
            }
            catch (Exception ex)
            {
                throw new Exception($"AwsS3StorageService başlatılırken hata oluştu: {ex.Message}", ex);
            }
        }

        /// <inheritdoc />
        public async Task<string> UploadAsync(string key, Stream content, string contentType)
        {
            var request = new PutObjectRequest
            {
                BucketName = _bucketName,
                Key = key,
                InputStream = content,
                ContentType = contentType
            };

            await _s3Client.PutObjectAsync(request);

            // POC için public URL varsayıyoruz
            return $"https://{_bucketName}.s3.amazonaws.com/{key}";
        }

        /// <inheritdoc />
        public Task<string> GetFileUrlAsync(string key)
        {
            // Gerçek senaryoda burada pre-signed URL de üretebilirsin.
            var url = $"https://{_bucketName}.s3.amazonaws.com/{key}";
            return Task.FromResult(url);
        }

        /// <inheritdoc />
        public async Task DeleteFileAsync(string key)
        {
            var request = new DeleteObjectRequest
            {
                BucketName = _bucketName,
                Key = key
            };

            await _s3Client.DeleteObjectAsync(request);
        }
    }
}
