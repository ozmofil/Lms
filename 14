// wwwroot/js/LmsScorm.js
// ============================================
// SCORM sekmesi iÃ§in frontend mantÄ±ÄŸÄ±
// - "EÄŸitimi BaÅŸlat" butonuna basÄ±ldÄ±ÄŸÄ±nda
//   S3'ten gelen SCORM launch URL iframe'e basÄ±lÄ±r
// - Ä°leride SCORM -> cmi5/xAPI mapping bu dosyada olacak
// ============================================

(function () {

    // KÃ¼Ã§Ã¼k yardÄ±mcÄ±: id ile element getir
    function byId(id) {
        return document.getElementById(id);
    }

    // ModÃ¼l state'i
    let _initialized = false;
    let _config = {};

    // JSON preview alanÄ±nÄ± gÃ¼ncelle
    function updatePreview() {
        const actor = byId("scorm-userId")?.value || "";
        const contentId = byId("scorm-contentId")?.value || "";
        const context = byId("scorm-context")?.value || "";

        const statement = {
            actor: actor,
            verb: "initialized",      // ÅŸimdilik sabit, ileride dinamik
            object: contentId,
            context: context,
            result: null,
            contentType: "scorm",
            timestamp: new Date().toISOString()
        };

        const preview = byId("scorm-json-preview");
        if (preview) {
            preview.textContent = JSON.stringify(statement, null, 2);
        }
    }

    // Basit log yazÄ±cÄ± (ileride backend Ã§aÄŸrÄ±sÄ± ekleyebiliriz)
    function appendLogRow(statementJson) {
        const logsContainer = document.querySelector("#scorm-logs tbody");
        if (!logsContainer) return;

        const tr = document.createElement("tr");

        const tdTime = document.createElement("td");
        tdTime.textContent = new Date().toLocaleString();

        const tdJson = document.createElement("td");
        const pre = document.createElement("pre");
        pre.className = "mb-0 small bg-light p-2";
        pre.textContent = statementJson;
        tdJson.appendChild(pre);

        tr.appendChild(tdTime);
        tr.appendChild(tdJson);

        logsContainer.prepend(tr); // en Ã¼ste ekle
    }

    // Backend'e SCORM statement POST etme (isteÄŸe baÄŸlÄ±)
    async function sendInitStatement(apiBaseUrl) {
        const actor = byId("scorm-userId")?.value || "";
        const contentId = byId("scorm-contentId")?.value || "";
        const context = byId("scorm-context")?.value || "";

        const statement = {
            actor,
            verb: "initialized",
            object: contentId,
            context,
            result: null,
            contentType: "scorm",
            timestamp: new Date().toISOString()
        };

        try {
            const response = await fetch(apiBaseUrl + "/statement", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(statement)
            });

            if (!response.ok) {
                console.warn("SCORM statement gÃ¶nderilemedi:", response.status);
                return;
            }

            const data = await response.json();
            appendLogRow(data.statementJson || JSON.stringify(statement));
        } catch (err) {
            console.error("SCORM statement gÃ¶nderim hatasÄ±:", err);
        }
    }

    // DÄ±ÅŸarÄ±dan Ã§aÄŸrÄ±lan init fonksiyonu
    function init(config) {
        console.log("LmsScorm.init Ã§aÄŸrÄ±ldÄ±");
        _config = config || {};
        const apiBaseUrl = _config.apiBaseUrl || "/api/cmi5";

        // DOM elemanlarÄ±nÄ± Ã§ek
        const btn = byId("scorm-start-btn");
        const iframe = byId("scorm-frame");

        if (!btn || !iframe) {
            console.warn("SCORM DOM hazÄ±r deÄŸil (btn veya iframe bulunamadÄ±), init iptal.");
            return;
        }

        if (_initialized) {
            console.log("LmsScorm: zaten init edilmiÅŸ, tekrar baÄŸlamÄ±yoruz.");
            return;
        }

        // "EÄŸitimi BaÅŸlat" butonuna click eventâ€™i baÄŸla
        btn.addEventListener("click", async () => {
            console.log("SCORM: EÄŸitimi BaÅŸlat tÄ±klandÄ±");

            try {
                // ğŸ”¹ 1) Backend'den S3'teki SCORM launch URL'i iste
                // Ã–rneÄŸin: GET /api/storage/scorm/launch?contentId=scorm1
                const contentId = byId("scorm-contentId")?.value || "scorm1";

                const resp = await fetch(`/api/storage/scorm/launch?contentId=${encodeURIComponent(contentId)}`);
                if (!resp.ok) {
                    console.error("SCORM launch URL alÄ±namadÄ±:", resp.status);
                    return;
                }

                const data = await resp.json();
                const launchUrl = data.launchUrl;  // { "launchUrl": "https://s3.../index.html?token=..." }

                // ğŸ”¹ 2) Iframe'e URL'i bas
                iframe.src = launchUrl || "/scorm/index.html"; // fallback: lokal demo

                console.log("SCORM iframe src set:", iframe.src);

                // ğŸ”¹ 3) Initialized statementâ€™i gÃ¶nder & logla
                updatePreview();
                await sendInitStatement(apiBaseUrl);

            } catch (err) {
                console.error("SCORM baÅŸlatÄ±lÄ±rken hata:", err);
            }
        });

        // Input deÄŸiÅŸtikÃ§e JSON preview gÃ¼ncellensin
        ["scorm-userId", "scorm-contentId", "scorm-context"].forEach(id => {
            const el = byId(id);
            if (!el) return;

            el.addEventListener("input", updatePreview);
            el.addEventListener("change", updatePreview);
        });

        // Sayfa ilk aÃ§Ä±ldÄ±ÄŸÄ±nda boÅŸ bir preview gÃ¶ster
        updatePreview();

        _initialized = true;
    }

    // Global objeyi publish et
    window.LmsScorm = {
        init
    };

})();
