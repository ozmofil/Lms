// wwwroot/js/LmsScorm.js
// SCORM tabındaki "Eğitimi Başlat" butonunu dinler,
// backend'den launchUrl alır, iframe'e yazar.
// Şimdilik odak: buton çalışsın ve iframe'e URL gelsin.

var LmsScorm = (function () {

    function init() {
        console.log("LmsScorm.init çağrıldı");

        const btn = document.getElementById("load-scorm-btn");
        const frame = document.getElementById("scorm-frame");

        if (!btn || !frame) {
            console.warn("LmsScorm: load-scorm-btn veya scorm-frame bulunamadı");
            return;
        }

        // Buton click event'i
        btn.addEventListener("click", async function () {
            console.log("LmsScorm: 'Eğitimi Başlat' tıklandı");

            const courseId = btn.dataset.courseId || "scorm1";

            try {
                const url = `/api/storage/scorm/launch?courseId=${encodeURIComponent(courseId)}`;
                console.log("LmsScorm: launch isteği:", url);

                const res = await fetch(url);
                console.log("LmsScorm: response status", res.status);

                if (!res.ok) {
                    throw new Error("Launch isteği başarısız: " + res.status);
                }

                const data = await res.json();
                console.log("LmsScorm: gelen data", data);

                if (!data.launchUrl) {
                    throw new Error("launchUrl dönmedi");
                }

                // SCORM içeriğini iframe içinde aç
                frame.src = data.launchUrl;
                console.log("LmsScorm: iframe.src =", data.launchUrl);

            } catch (err) {
                console.error("LmsScorm: hata", err);

                // Hata durumunda iframe'e basit bir mesaj yazdır
                const doc = frame.contentDocument || frame.contentWindow?.document;
                if (doc) {
                    doc.open();
                    doc.write(`<html><body style="font-family: sans-serif; padding:16px;">
                        <h3>SCORM başlatılırken hata oluştu</h3>
                        <pre>${err.message}</pre>
                    </body></html>`);
                    doc.close();
                }
            }
        });
    }

    return {
        init: init
    };

})();
