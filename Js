// wwwroot/js/LmsScorm.js
// SCORM tabındaki "Eğitimi Başlat" butonuna tıklandığında
// backend'den launchUrl alıp iframe'e basar.

var LmsScorm = (function () {

    function init() {
        console.log("LmsScorm.init çağrıldı");

        const btn   = document.getElementById("load-scorm-btn");
        const frame = document.getElementById("scorm-frame");

        // Element bulunamadıysa hata verip uygulamayı kırma
        if (!btn) {
            console.warn("LmsScorm: #load-scorm-btn bulunamadı. Id'yi kontrol et.");
            return;
        }
        if (!frame) {
            console.warn("LmsScorm: #scorm-frame bulunamadı. Id'yi kontrol et.");
            return;
        }

        // Aynı event'i birden fazla eklememek için önce temizleyelim
        btn.onclick = null;

        btn.addEventListener("click", function () {
            console.log("LmsScorm: 'Eğitimi Başlat' tıklandı");
            startScorm(btn, frame);
        });
    }

    async function startScorm(btn, frame) {
        const courseId = btn.dataset.courseId || "scorm1";

        try {
            const url = `/api/storage/scorm/launch?courseId=${encodeURIComponent(courseId)}`;
            console.log("LmsScorm: launch isteği:", url);

            const res = await fetch(url);
            console.log("LmsScorm: response status", res.status);

            if (!res.ok) {
                throw new Error("Launch isteği başarısız: " + res.status);
            }

            const data = await res.json();
            console.log("LmsScorm: gelen data", data);

            if (!data.launchUrl) {
                throw new Error("launchUrl dönmedi");
            }

            frame.src = data.launchUrl;
            console.log("LmsScorm: iframe.src =", data.launchUrl);

        } catch (err) {
            console.error("LmsScorm: hata", err);

            const doc = frame.contentDocument || frame.contentWindow?.document;
            if (doc) {
                doc.open();
                doc.write(`<html><body style="font-family: sans-serif; padding:16px;">
                    <h3>SCORM başlatılırken hata oluştu</h3>
                    <pre>${err.message}</pre>
                </body></html>`);
                doc.close();
            }
        }
    }

    return {
        init: init
    };

})();
