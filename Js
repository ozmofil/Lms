// wwwroot/js/LmsContentUpload.js
// "İçerik Yönetimi" tabında:
// - Eğitim türüne göre dosya upload eder (/api/storage/upload)
// - S3'ten içerik listesini çeker (/api/storage/list)
// - Listeyi tabloda gösterir
// Bu dosya sadece admin/upload işinden sorumlu.

(function () {

    // Dışarıdan erişilecek tek nokta: LmsUpload.init()
    function init() {
        console.log("LmsUpload.init başladı.");

        const typeSelect    = document.getElementById("admin-contentType");
        const fileInput     = document.getElementById("admin-file");
        const uploadBtn     = document.getElementById("admin-upload-btn");
        const statusLabel   = document.getElementById("admin-upload-status");
        const listContainer = document.getElementById("admin-content-list");

        // Güvenlik için element kontrolleri
        if (!uploadBtn || !typeSelect || !fileInput || !statusLabel || !listContainer) {
            console.warn("LmsUpload: admin upload elementlerinden biri bulunamadı.");
            return;
        }

        console.log("LmsUpload: admin upload elementleri bulundu.");

        // ---- S3 listesini çeken fonksiyon ----
        async function loadList() {
            const contentType = typeSelect.value;
            console.log("LmsUpload: liste yükleniyor, tür:", contentType);

            listContainer.innerHTML = "Yükleniyor...";

            try {
                const response = await fetch(`/api/storage/list?contentType=${encodeURIComponent(contentType)}`);
                if (!response.ok) {
                    throw new Error("Liste alınamadı: " + response.status);
                }

                const items = await response.json();
                console.log("LmsUpload: liste sonucu:", items);

                if (!items || items.length === 0) {
                    listContainer.innerHTML = "<p>Bu türde henüz içerik yok.</p>";
                    return;
                }

                let html = `<table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Önizleme / Link</th>
                        </tr>
                    </thead>
                    <tbody>`;

                items.forEach(item => {
                    html += `<tr>
                        <td class="small">${item.key}</td>
                        <td><a href="${item.url}" target="_blank">Aç</a></td>
                    </tr>`;
                });

                html += "</tbody></table>";
                listContainer.innerHTML = html;

            } catch (err) {
                console.error("LmsUpload: liste hatası", err);
                listContainer.innerHTML = `<p class="text-danger">Hata: ${err.message}</p>`;
            }
        }

        // ---- Dosya upload eden fonksiyon ----
        async function uploadFile() {
            const contentType = typeSelect.value;
            const files = fileInput.files;

            console.log("LmsUpload: upload tetiklendi.");

            if (!files || files.length === 0) {
                statusLabel.textContent = "Lütfen bir dosya seçin.";
                return;
            }

            const file = files[0];

            const formData = new FormData();
            formData.append("file", file);
            formData.append("contentType", contentType);

            statusLabel.textContent = "Yükleniyor...";

            try {
                console.log("LmsUpload: upload isteği gönderiliyor:", contentType, file.name);

                const response = await fetch("/api/storage/upload", {
                    method: "POST",
                    body: formData
                });

                if (!response.ok) {
                    throw new Error("Sunucu hatası: " + response.status);
                }

                const data = await response.json();
                console.log("LmsUpload: upload tamamlandı:", data);

                statusLabel.textContent = "Yükleme tamamlandı.";

                // Yükleme sonrası listeyi yenile
                await loadList();

            } catch (err) {
                console.error("LmsUpload: upload hatası", err);
                statusLabel.textContent = "Hata: " + err.message;
            }
        }

        // ---- Event bağlama ----

        // Yükle butonu tıklanınca upload yap
        uploadBtn.addEventListener("click", function (e) {
            e.preventDefault();
            console.log("LmsUpload: Yükle butonuna tıklandı.");
            uploadFile();
        });

        // Eğitim türü değişince listeyi yenile
        typeSelect.addEventListener("change", function () {
            loadList();
        });

        // Sayfa ilk açıldığında varsayılan tür için listeyi getir
        loadList();

        console.log("LmsUpload.init bitti.");
    }

    // Global obje: sadece init fonksiyonu dışarı açılıyor
    window.LmsUpload = {
        init: init
    };

})();
